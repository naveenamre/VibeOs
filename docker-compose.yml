version: "3.8"

services:
  # --- CORE VIBEOS (Purana Setup) ---

  # 1. Database for n8n
  postgres:
    image: postgres:13-alpine
    restart: always
    environment:
      - POSTGRES_USER=vibeuser
      - POSTGRES_PASSWORD=vibepassword
      - POSTGRES_DB=n8n
    volumes:
      - ./data/postgres_data:/var/lib/postgresql/data
    networks:
      - vibe-network

  # 2. Orchestrator (n8n)
  n8n:
    image: docker.n8n.io/n8nio/n8n
    restart: always
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=vibeuser
      - DB_POSTGRESDB_PASSWORD=vibepassword
    volumes:
      - ./data/n8n_data:/home/node/.n8n
      - ./data:/data
    depends_on:
      - postgres
    networks:
      - vibe-network

  # 3. The Brain (Custom Python API)
  scheduler-brain:
    build: ./scheduler_brain
    restart: always
    ports:
      - "5000:5000"
    volumes: # <--- YE SECTION ADD KARNA
      - ./data:/app/data # Local 'data' folder ko Docker ke '/app/data' se link karo
    networks:
      - vibe-network
  # --- PLANE (PROJECT MANAGEMENT STACK) ---

  # 4. Plane Database (Alag Postgres instance for safety)
  plane-db:
    image: postgres:15-alpine
    restart: always
    environment:
      - POSTGRES_USER=plane
      - POSTGRES_PASSWORD=plane
      - POSTGRES_DB=plane
      - PGDATA=/var/lib/postgresql/data
    volumes:
      - ./data/plane_db:/var/lib/postgresql/data
    networks:
      - vibe-network

  # 5. Redis (Speed ke liye)
  plane-redis:
    image: redis:7-alpine
    restart: always
    volumes:
      - ./data/plane_redis:/data
    networks:
      - vibe-network

  # 6. MinIO (File Storage - Images/Docs)
  plane-minio:
    image: minio/minio
    restart: always
    command: server /data --console-address ":9090"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - ./data/plane_storage:/data
    networks:
      - vibe-network

  # 7. Plane Backend (API)
  plane-api:
    image: makeplane/plane-backend:latest
    restart: always
    environment:
      - DATABASE_URL=postgresql://plane:plane@plane-db/plane
      - REDIS_URL=redis://plane-redis:6379/
      - EMAIL_HOST=smtp.gmail.com
      - EMAIL_HOST_USER=noreply@vibeos.com
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - AWS_S3_ENDPOINT_URL=http://plane-minio:9000
      - AWS_S3_BUCKET_NAME=plane-bucket
      - SECRET_KEY=vibeos-secret-key-change-this
      - WEB_URL=http://localhost:8090
      - DOCKERIZED=1
    depends_on:
      - plane-db
      - plane-redis
      - plane-minio
    networks:
      - vibe-network

  # 8. Plane Frontend (UI)
  plane-web:
    image: makeplane/plane-frontend:latest
    restart: always
    ports:
      - "8090:3000"
    environment:
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:8090/api
    depends_on:
      - plane-api
    networks:
      - vibe-network

  # 9. Plane Worker (Background Jobs)
  plane-worker:
    image: makeplane/plane-worker:latest
    restart: always
    environment:
      - DATABASE_URL=postgresql://plane:plane@plane-db/plane
      - REDIS_URL=redis://plane-redis:6379/
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - AWS_S3_ENDPOINT_URL=http://plane-minio:9000
      - AWS_S3_BUCKET_NAME=plane-bucket
      - SECRET_KEY=vibeos-secret-key-change-this
    depends_on:
      - plane-db
      - plane-redis
    networks:
      - vibe-network

networks:
  vibe-network:
    driver: bridge
